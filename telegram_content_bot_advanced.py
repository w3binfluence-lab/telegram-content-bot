import os
import logging
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram import F
import anthropic
import asyncio
from typing import Optional

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
TELEGRAM_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
ANTHROPIC_API_KEY = os.getenv('ANTHROPIC_API_KEY')

bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()
client = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY)

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–≤ –ø–∞–º—è—Ç–∏, –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
user_stats = {}

# –†–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
CONTENT_STYLES = {
    'fun': {
        'name': 'üòÑ –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π',
        'prompt': """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –≤–∏—Ä—É—Å–Ω–æ–≥–æ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è Telegram.

–°—Ç–∏–ª—å: –õ–µ–≥–∫–∏–π, –≤–µ—Å–µ–ª—ã–π, —Å —é–º–æ—Ä–æ–º –∏ —ç–º–æ—Ü–∏—è–º–∏
–¶–µ–ª—å: –†–∞–∑–≤–ª–µ—á—å –∞—É–¥–∏—Ç–æ—Ä–∏—é, –≤—ã–∑–≤–∞—Ç—å —É–ª—ã–±–∫—É
–ò—Å–ø–æ–ª—å–∑—É–π: Emojis, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã"""
    },
    'educational': {
        'name': 'üéì –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π',
        'prompt': """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è Telegram.

–°—Ç–∏–ª—å: –ü–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π
–¶–µ–ª—å: –ù–∞—É—á–∏—Ç—å —á–µ–º—É-—Ç–æ –Ω–æ–≤–æ–º—É
–ò—Å–ø–æ–ª—å–∑—É–π: –§–∞–∫—Ç—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –ø—Ä–æ—Å—Ç—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è"""
    },
    'shocking': {
        'name': 'üò± –®–æ–∫–∏—Ä—É—é—â–∏–π',
        'prompt': """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —à–æ–∫–∏—Ä—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è Telegram.

–°—Ç–∏–ª—å: –°–µ–Ω—Å–∞—Ü–∏–æ–Ω–Ω—ã–π, –∏–Ω—Ç—Ä–∏–≥—É—é—â–∏–π, —Å wow-—ç—Ñ—Ñ–µ–∫—Ç–æ–º
–¶–µ–ª—å: –£–¥–∏–≤–∏—Ç—å –∏ –ø–æ—Ä–∞–∑–∏—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏—é
–ò—Å–ø–æ–ª—å–∑—É–π: –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤–æ—Ä–æ—Ç—ã"""
    },
    'motivational': {
        'name': 'üí™ –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π',
        'prompt': """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è Telegram.

–°—Ç–∏–ª—å: –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π, —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π
–¶–µ–ª—å: –ó–∞–º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏ –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç—å
–ò—Å–ø–æ–ª—å–∑—É–π: –ò—Å—Ç–æ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã"""
    }
}

# –¢–µ–∫—É—â–∏–π —Å—Ç–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π)
user_styles = {}

# –ë–∞–∑–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
BASE_SYSTEM_PROMPT = """
–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è —Å–∞–º–æ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
2. –£–±—Ä–∞—Ç—å –≤—Å—é –≤–æ–¥—É –∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ —Ü–µ–ø–ª—è—é—â–µ–µ
3. –ù–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) —Ç–µ–∫—Å—Ç –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —Å—Ç–∏–ª–µ
4. –°–æ–∑–¥–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üì± –¢–ï–ö–°–¢ –î–õ–Ø –ü–û–°–¢–ê:
[–¶–µ–ø–ª—è—é—â–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –≤–æ–¥—ã, 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π]

üé¨ –ü–†–û–ú–ü–¢ –î–õ–Ø –í–ò–î–ï–û:
[–î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–ª—è AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ]

–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ —Ü–µ–ø–ª—è—é—â–µ
- –ù–∏–∫–∞–∫–æ–π –≤–æ–¥—ã, —Ç–æ–ª—å–∫–æ —Å—É—Ç—å
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç–∏–ª—é
- –ò—Å–ø–æ–ª—å–∑—É–π emojis –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤
- 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª—å—à–µ!)

–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞:
- –ù–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å—Ü–µ–Ω—ã
- –£–∫–∞–∑—ã–≤–∞–π: –æ—Å–≤–µ—â–µ–Ω–∏–µ, –∫–∞–º–µ—Ä—É, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Å—Ç–∏–ª—å
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è Haiper/Pika/Runway
- –í–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∏ –¥–∏–Ω–∞–º–∏—á–Ω—ã–π
"""


async def generate_content(topic: str, style: str = 'fun') -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Claude API —Å –≤–µ–±-–ø–æ–∏—Å–∫–æ–º"""
    try:
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ —Å—Ç–∏–ª–µ–º
        style_prompt = CONTENT_STYLES.get(style, CONTENT_STYLES['fun'])['prompt']
        full_system_prompt = style_prompt + "\n\n" + BASE_SYSTEM_PROMPT
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Claude —Å web search
        message = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=2000,
            temperature=1,
            system=full_system_prompt,
            messages=[{
                "role": "user",
                "content": f"–¢–µ–º–∞: {topic}\n\n–ù–∞–π–¥–∏ —Å–∞–º—É—é –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –∏ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ò—Å–ø–æ–ª—å–∑—É–π –≤–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –°–æ–∑–¥–∞–π —Ü–µ–ø–ª—è—é—â–∏–π –ø–æ—Å—Ç –∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ."
            }]
        )
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞
        response_text = ""
        for block in message.content:
            if hasattr(block, 'text'):
                response_text += block.text
        
        return response_text
        
    except Exception as e:
        logger.error(f"Error generating content: {e}")
        return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {str(e)}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n- –ë–∞–ª–∞–Ω—Å Claude API\n- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞\n- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"


def get_style_keyboard() -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è"""
    buttons = []
    for style_key, style_data in CONTENT_STYLES.items():
        buttons.append([InlineKeyboardButton(
            text=style_data['name'],
            callback_data=f"style_{style_key}"
        )])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_stats(user_id: int) -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id not in user_stats:
        user_stats[user_id] = {
            'requests': 0,
            'first_use': datetime.now(),
            'last_use': datetime.now()
        }
    return user_stats[user_id]


def update_stats(user_id: int):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    stats = get_stats(user_id)
    stats['requests'] += 1
    stats['last_use'] = datetime.now()


@dp.message(Command("start"))
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = message.from_user.id
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if user_id not in user_styles:
        user_styles[user_id] = 'fun'
    
    welcome_text = """ü§ñ –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏—Ä—É—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

üéØ **–ß—Ç–æ —è —É–º–µ—é:**
‚úÖ –ò—â—É –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
‚úÖ –£–±–∏—Ä–∞—é –≤–æ–¥—É, –æ—Å—Ç–∞–≤–ª—è—é —Ç–æ–ª—å–∫–æ —Å—É—Ç—å
‚úÖ –°–æ–∑–¥–∞—é —Ü–µ–ø–ª—è—é—â–∏–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ø–æ—Å—Ç–æ–≤
‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è AI-–≤–∏–¥–µ–æ

üìù **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:**
1. –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞: /style
2. –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ç–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—Ç–æ–ø —Ñ–∞–∫—Ç–æ–≤ –æ –∫–æ—Å–º–æ—Å–µ")
3. –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç + –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ
4. –ü—É–±–ª–∏–∫—É–π –≤ —Å–≤–æ–µ–º –∫–∞–Ω–∞–ª–µ!

üí° **–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–º:**
‚Ä¢ –°–∞–º—ã–µ —Å—Ç—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫–æ–Ω—ã —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω
‚Ä¢ –ù–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–µ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è 2025 –≥–æ–¥–∞
‚Ä¢ –¢–æ–ø –º–µ–º—ã —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞
‚Ä¢ –§–∞–∫—Ç—ã –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ —É–¥–∏–≤—è—Ç

‚öôÔ∏è **–ö–æ–º–∞–Ω–¥—ã:**
/style - –í—ã–±—Ä–∞—Ç—å —Å—Ç–∏–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞
/stats - –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/help - –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞

–î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º! –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ç–µ–º—É üëá"""
    
    await message.answer(welcome_text, parse_mode='Markdown')


@dp.message(Command("style"))
async def cmd_style(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /style"""
    user_id = message.from_user.id
    current_style = user_styles.get(user_id, 'fun')
    current_name = CONTENT_STYLES[current_style]['name']
    
    text = f"üé® **–í—ã–±–æ—Ä —Å—Ç–∏–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞**\n\n–¢–µ–∫—É—â–∏–π —Å—Ç–∏–ª—å: {current_name}\n\n–í—ã–±–µ—Ä–∏ –Ω–æ–≤—ã–π —Å—Ç–∏–ª—å:"
    
    await message.answer(
        text,
        reply_markup=get_style_keyboard(),
        parse_mode='Markdown'
    )


@dp.callback_query(F.data.startswith("style_"))
async def process_style_selection(callback: types.CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è"""
    user_id = callback.from_user.id
    style = callback.data.replace("style_", "")
    
    if style in CONTENT_STYLES:
        user_styles[user_id] = style
        style_name = CONTENT_STYLES[style]['name']
        
        await callback.message.edit_text(
            f"‚úÖ –°—Ç–∏–ª—å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {style_name}\n\n–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ç–µ–º—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞!",
            parse_mode='Markdown'
        )
    
    await callback.answer()


@dp.message(Command("stats"))
async def cmd_stats(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = message.from_user.id
    stats = get_stats(user_id)
    
    current_style = user_styles.get(user_id, 'fun')
    style_name = CONTENT_STYLES[current_style]['name']
    
    first_use = stats['first_use'].strftime("%d.%m.%Y")
    last_use = stats['last_use'].strftime("%d.%m.%Y %H:%M")
    
    stats_text = f"""üìä **–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**

üéØ –¢–µ–∫—É—â–∏–π —Å—Ç–∏–ª—å: {style_name}
üìù –ó–∞–ø—Ä–æ—Å–æ–≤ —Å–¥–µ–ª–∞–Ω–æ: {stats['requests']}
üìÖ –ü–µ—Ä–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {first_use}
üïê –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å: {last_use}

üí° –•–æ—á–µ—à—å —Å–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å? –ò—Å–ø–æ–ª—å–∑—É–π /style"""
    
    await message.answer(stats_text, parse_mode='Markdown')


@dp.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞**

üéØ **–û—Å–Ω–æ–≤—ã:**
–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç AI (Claude) –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –û–Ω –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ —Å–æ–∑–¥–∞–µ—Ç —Ü–µ–ø–ª—è—é—â–∏–µ –ø–æ—Å—Ç—ã.

üìù **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

1Ô∏è‚É£ –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (/style):
   ‚Ä¢ üòÑ –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π - –¥–ª—è –≤–µ—Å–µ–ª—ã—Ö –ø–æ—Å—Ç–æ–≤
   ‚Ä¢ üéì –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π - –¥–ª—è –ø–æ–ª–µ–∑–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
   ‚Ä¢ üò± –®–æ–∫–∏—Ä—É—é—â–∏–π - –¥–ª—è wow-—ç—Ñ—Ñ–µ–∫—Ç–∞
   ‚Ä¢ üí™ –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π - –¥–ª—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è

2Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å —Ç–µ–º—É –≤ —á–∞—Ç:
   ‚Ä¢ "–°–∞–º—ã–µ –Ω–µ–æ–±—ã—á–Ω—ã–µ –∑–¥–∞–Ω–∏—è –º–∏—Ä–∞"
   ‚Ä¢ "–¢–æ–ø —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π 2025 –≥–æ–¥–∞"
   ‚Ä¢ "–°—Ç—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –Ø–ø–æ–Ω–∏–∏"

3Ô∏è‚É£ –ü–æ–ª—É—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   ‚Ä¢ –ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Å—Ç–∞ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
   ‚Ä¢ –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI-–≤–∏–¥–µ–æ

4Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–º–ø—Ç:
   ‚Ä¢ –°–∫–æ–ø–∏—Ä—É–π –ø—Ä–æ–º–ø—Ç
   ‚Ä¢ –í—Å—Ç–∞–≤—å –≤ Haiper.ai, Pika –∏–ª–∏ Runway
   ‚Ä¢ –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–∏–¥–µ–æ
   ‚Ä¢ –û–ø—É–±–ª–∏–∫—É–π —Å —Ç–µ–∫—Å—Ç–æ–º!

üí° **–°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**

‚úÖ –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º: "—Ç–æ–ø 5 —Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –æ..."
‚úÖ –£–∫–∞–∑—ã–≤–∞–π –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å: "—Ç—Ä–µ–Ω–¥—ã 2025", "–Ω–æ–≤–∏–Ω–∫–∏..."
‚úÖ –í—ã–±–∏—Ä–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ç–µ–º—ã: –Ω–µ–æ–±—ã—á–Ω–æ–µ, —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–µ
‚ùå –ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ç–µ–º: "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ –∫–æ—Å–º–æ—Å–µ"

üé¨ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ:**

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞:
1. –û—Ç–∫—Ä–æ–π [haiper.ai](https://haiper.ai) (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
2. –í—Å—Ç–∞–≤—å –ø—Ä–æ–º–ø—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
3. –ù–∞–∂–º–∏ Generate
4. –ü–æ–¥–æ–∂–¥–∏ 20-30 —Å–µ–∫—É–Ω–¥
5. –°–∫–∞—á–∞–π –≤–∏–¥–µ–æ
6. –ü—É–±–ª–∏–∫—É–π!

‚öôÔ∏è **–ö–æ–º–∞–Ω–¥—ã:**
/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/style - –°–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞
/stats - –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

‚ùì **–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã:**

**Q: –ë–æ—Ç –¥–æ–ª–≥–æ –¥—É–º–∞–µ—Ç?**
A: –î–∞, AI-–ø–æ–∏—Å–∫ –∑–∞–Ω–∏–º–∞–µ—Ç 10-30 —Å–µ–∫. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ–º?**
A: –î–∞! –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–π –ø–æ –æ–¥–Ω–æ–π —Ç–µ–º–µ –∑–∞ —Ä–∞–∑.

**Q: –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç?**
A: –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ–Ω –∑–∞–ø—É—â–µ–Ω. –ù–∞–ø–∏—à–∏ /start

**Q: –ö–∞–∫ —É–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?**
A: –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ–º—ã –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π —Å–æ —Å—Ç–∏–ª—è–º–∏.

üí∞ **–õ–∏–º–∏—Ç—ã:**
–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Claude API. –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–∞—é—Ç $5 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤ (‚âà500-1000 –∑–∞–ø—Ä–æ—Å–æ–≤).

üÜò **–ü—Ä–æ–±–ª–µ–º—ã?**
–ù–∞–ø–∏—à–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start

–£–¥–∞—á–∏ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º! üöÄ"""
    
    await message.answer(help_text, parse_mode='Markdown')


@dp.message(F.text)
async def handle_topic(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
    user_id = message.from_user.id
    topic = message.text
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞
    if topic.startswith('/'):
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    style = user_styles.get(user_id, 'fun')
    style_name = CONTENT_STYLES[style]['name']
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    update_stats(user_id)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_msg = await message.answer(
        f"üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–º–µ: *{topic}*\n"
        f"üé® –°—Ç–∏–ª—å: {style_name}\n\n"
        f"‚è≥ –≠—Ç–æ –∑–∞–π–º–µ—Ç 10-30 —Å–µ–∫—É–Ω–¥...",
        parse_mode='Markdown'
    )
    
    try:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        content = await generate_content(topic, style)
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
        await processing_msg.delete()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∏–ª–µ
        footer = f"\n\n---\nüé® –°—Ç–∏–ª—å: {style_name}\nüí° –°–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å: /style"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await message.answer(content + footer, parse_mode=None)
        
        # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        logger.info(f"User {user_id} generated content for topic: {topic[:50]}")
        
    except Exception as e:
        logger.error(f"Error in handle_topic: {e}")
        await processing_msg.edit_text(
            f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–º—É (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞)\n"
            f"‚Ä¢ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É\n"
            f"‚Ä¢ –ù–∞–ø–∏—Å–∞—Ç—å /help –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤",
            parse_mode='Markdown'
        )


async def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    logger.info("Starting Telegram Content Bot...")
    logger.info(f"Bot initialized at {datetime.now()}")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–æ–≤
    if not TELEGRAM_TOKEN:
        raise ValueError("‚ùå TELEGRAM_BOT_TOKEN not found in environment variables")
    if not ANTHROPIC_API_KEY:
        raise ValueError("‚ùå ANTHROPIC_API_KEY not found in environment variables")
    
    logger.info("‚úÖ Environment variables loaded")
    logger.info("‚úÖ Starting polling...")
    
    # –ó–∞–ø—É—Å–∫ polling
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.error(f"Error during polling: {e}")
        raise


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("Bot stopped by user")
    except Exception as e:
        logger.error(f"Fatal error: {e}")
